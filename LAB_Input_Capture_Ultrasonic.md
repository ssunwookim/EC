# LAB: Input Capture - Ultrasonic



**Date:** 2023-11-07

**Author:** 김선우

**Github:** 

**Demo Video:** EC_LAB: Input Capture - Ultrasonic_김선우 



## Introduction

 In this lab, you are required to create a simple program that uses input capture mode to measure the distance using an ultrasonic distance sensor. The sensor also needs trigger pulses that can be generated by using the timer output.



### Requirement

#### Hardware

- MCU
  - NUCLEO-F411RE
- Actuator/Sensor/Others:
  - HC-SR04
  - breadboard

#### Software

- Keil uVision, CMSIS, EC_HAL library



## Problem 1: Create HAL library

### Create HAL library

Declare and Define the following functions in your library. You must update your header files located in the directory `EC \lib\`.

##### ecUART_simple.h

```c
#ifndef __EC_USART_SIMPLE_H
#define __EC_USART_SIMPLE_H

#include "stm32f411xe.h"
#include <stdio.h>
#include "ecGPIO.h"
#include "ecRCC.h"

#define POL 0
#define INT 1

// You can modify this
#define BAUD_9600		0
#define BAUD_19200	1
#define BAUD_57600	2
#define BAUD_115200 3
#define BAUD_921600 4


// ********************** USART 2 (USB) ***************************
	// PA_2 = USART2_TX
	// PA_3 = USART2_RX
	// Alternate function(AF7), High Speed, Push pull, Pull up
	// APB1
// **********************************************************



/* UART2 Initialization to use printf() */
void UART2_init();
void USART_write(USART_TypeDef* USARTx, uint8_t* buffer, uint32_t nBytes);
void USART_delay(uint32_t us);  


										

#endif
```

##### ecICAP.h

```c
#ifndef __EC_ICAP_H
#define __EC_ICAP_H
#include "stm32f411xe.h"
#include "ecPinNames.h""

#ifdef __cplusplus
 extern "C" {
#endif /* __cplusplus */


/* Input Capture*/

// ICn selection according to CHn
#define FIRST 1
#define SECOND 2

// Edge Type
#define IC_RISE 0
#define IC_FALL 1
#define IC_BOTH 2

// Input Capture Number
#define IC_1    1
#define IC_2    2
#define IC_3    3
#define IC_4    4

//Input Capture

void ICAP_pinmap(PinName_t pinName, TIM_TypeDef **TIMx, int *chN);

void ICAP_init(PinName_t pinName);
void ICAP_setup(PinName_t pinName, int ICn, int edge_type);
void ICAP_counter_us(PinName_t pinName, int usec);
uint32_t ICAP_capture	(TIM_TypeDef* TIMx, uint32_t ICn);

uint32_t is_CCIF(TIM_TypeDef *TIMx, uint32_t CCnum);  // CCnum= 1~4
void clear_CCIF(TIM_TypeDef *TIMx, uint32_t CCnum);



#ifdef __cplusplus
}
#endif /* __cplusplus */

#endif
```



## Problem 2: Ultrasonic Distance Sensor (HC-SR04)

The HC-SR04 ultrasonic distance sensor. This economical sensor provides 2cm to 400cm of non-contact measurement functionality with a ranging accuracy that can reach up to 3mm. Each HC-SR04 module includes an ultrasonic transmitter, a receiver and a control circuit.



### Procedure

1. Create a new project under the directory `\repos\EC\LAB\LAB_Timer_InputCaputre_Ultrasonic`

- The project name is “**LAB_Timer_InputCaputre_Ultrasonic”.**
- Create a new source file named as “**LAB_Timer_InputCaputre_Ultrasonic.c”**

2. Include your updated library in `\repos\EC\lib\` to your project.

- **ecGPIO.h, ecGPIO.c**
- **ecRCC.h, ecRCC.c**
- **ecTIM.h, ecTIM.c**
- **ecPWM.h, ecPWM.c**
- **ecSysTick.h, ecSysTick.c**
- **ecUART_simple.h, ecUART_simple.c**
- Connect the HC-SR04 ultrasonic distance sensor to MCU pins(PA6 - trigger, PB6 - echo), VCC and GND



### Measurement of Distance

The program needs to

- Generate a trigger pulse as PWM to the sensor.

- Receive echo pulses from the ultrasonic sensor

- Measure the distance by calculating pulse-width of the echo pulse.

- Display measured distance in [cm] on serial monitor of Tera-Term for

  (a) 10mm (b) 50mm (c) 100mm



### Configuration

| System Clock | PWM                                       | Input Capture                                                |
| ------------ | ----------------------------------------- | ------------------------------------------------------------ |
| PLL (84MHz)  | PA6 (TIM3_CH1)                            | PB6 (TIM4_CH1)                                               |
|              | AF, Push-Pull, No Pull-up Pull-down, Fast | AF, No Pull-up Pull-down                                     |
|              | PWM period: 50msec pulse width: 10usec    | Counter Clock : 0.1MHz (10us) TI4 -> IC1 (rising edge) TI4 -> IC2 (falling edge) |



### Circuit Diagram

> ![image-20231107092834021](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231107092834021.png)



### Discussion

1. There can be an over-capture case, when a new capture interrupt occurs before reading the CCR value. When does it occur and how can you calculate the time span accurately between two captures?

>  Over-capture occurs when measuring the time of a frequent event, when the event time exceeds the sensor and MCU computing capabilities, or when the timer's limited precision cannot accurately capture the event. A possible solution to this is to store timestamps for both captures to prevent overcapture. After each capture event, we calculate the time difference between the two most recent timestamps. You can accurately calculate the time interval between two events by subtracting the first timestamp from the second timestamp.

1. In the tutorial, what is the accuracy when measuring the period of 1Hz square wave? Show your result.

- main code

```c
#include "stm32f411xe.h"
#include "math.h"
#include "ecGPIO.h"
#include "ecRCC.h"
#include "ecTIM.h"
#include "ecUART_simple.h"
#include "ecSysTick.h"
#include "ecICAP.h".h"
#include "ecPWM.h"

uint32_t ovf_cnt = 0;
uint32_t ccr1 = 0;
uint32_t ccr2 = 0;
float    period = 0;

void setup(void);

int main(void){
	
	setup();
	while(1){
		printf("period = %f[msec]\r\n", period);		// print out the period on TeraTerm
		delay_ms(1000);
	}
}

void setup(void) {	
	// Configuration Clock PLL
	RCC_PLL_init();
	
	// UART2 Configuration to use printf()
	UART2_init();
	
	// SysTick Configuration to use delay_ms()
	SysTick_init();

	// Input Capture Configuration PA_0(TIM2, 1)
	ICAP_init(PA_0);
	
	// PWM configuration ---------------------------------------------------------------------	
	PWM_init(PA_6);							  	// PA_6: Ultrasonic trig pulse
	PWM_period_ms(PA_6, 1000);     // PWM of 1s period. Use period_us()
	PWM_duty(PA_6, 0.5);    // PWM pulse width of 10us
	
	// Priority Configuration
	NVIC_SetPriority(TIM2_IRQn, 2);						// Set the priority of TIM2 interrupt request
	NVIC_EnableIRQ(TIM2_IRQn);							// TIM2 interrupt request enable
}

// Timer2 IRQ Handler (timer & Input Capture)
void TIM2_IRQHandler(void){
	if(is_UIF(TIM2)){                  // If Update-event interrupt Occurs
		// Handle overflow
		ovf_cnt++;
		
		clear_UIF(TIM2);   					// clear update-event interrupt flag
	}
	if(is_CCIF(TIM2, IC_1)){				// if CC interrupt occurs	
		// Calculate the period of 1Hz pulse
		ccr2 = ICAP_capture(TIM2, IC_1);						// capture counter value
		period = ((ccr2 - ccr1) + ovf_cnt * (TIM2->ARR + 1)) / 1000; 		// calculate the period with ovf_cnt, ccr1, and ccr2
		
		ccr1 = ccr2;
		ovf_cnt = 0;
		
		clear_CCIF(TIM2, IC_1);	// clear capture/compare interrupt flag ( it is also cleared by reading TIM2_CCR1)
	}
}
```

- result

| Input Signal (Freq: 1Hz)                                     | Output                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20231106223336878](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231106223336878.png) | ![image-20231106222134519](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231106222134519.png) |

 In the experimental setup, a 1Hz signal generated by a function generator was applied to a sensor. The objective was to measure the time elapsed between the rising edges of the signal. The implemented code successfully captured these rising edges. The measured time difference between the start and end edges was consistently found to be 1 second, aligning with the expected behavior of a 1Hz signal. Notably, this measurement showed excellent agreement with the theoretical value. In terms of the precision of the measurement, the simulation results exhibited a negligible error, well within an acceptable error range of 10 milliseconds. This level of accuracy demonstrates the robustness of the measurement system and validates its suitability for precise time interval measurements.The results indicate that the code and experimental setup provided accurate and reliable measurements of the signal's rising edges, with a high degree of consistency and minimal deviation from the expected values.



### Code

1. Main Code

```c
#include "stm32f411xe.h"
#include "math.h"
#include "ecGPIO.h"
#include "ecRCC.h"
#include "ecTIM.h"
#include "ecPWM.h"
#include "ecUART_simple.h"
#include "ecSysTIck.h"
#include "ecICAP.h"

uint32_t ovf_cnt = 0;
float distance = 0;
float timeInterval = 0;
float time1 = 0;
float time2 = 0;

#define TRIG PA_6
#define ECHO PB_6

void setup(void);

int main(void){
	
	setup();
	
	while(1){
		distance = (float) timeInterval * 340.0 / 2.0 / 10.0; 	// [mm] -> [cm]
		printf("%f cm\r\n", distance);
		delay_ms(500);
	}
}

void TIM4_IRQHandler(void){
	if(is_UIF(TIM4)){                     			// Update interrupt 
		ovf_cnt++			 ;													// overflow count
		clear_UIF(TIM4);  							   				// clear update interrupt flag
	}
	if(is_CCIF(TIM4, IC_1)){ 										// TIM4_Ch1 (IC1) Capture Flag. Rising Edge Detect
		time1 = ICAP_capture(TIM4, IC_1);					// Capture TimeStart
		clear_CCIF(TIM4, 1);                			// clear capture/compare interrupt flag 
	}								                      
	else if(is_CCIF(TIM4, IC_2)){ 							// TIM4_Ch2 (IC2) Capture Flag. Falling Edge Detect
		time2 = ICAP_capture(TIM4, IC_2);					// Capture TimeEnd
		timeInterval = ((time2 - time1) + ovf_cnt * (TIM2->ARR + 1)) / 100; 	// (10us * counter pulse -> [msec] unit) Total time of echo pulse
		ovf_cnt = 0;                        			// overflow reset
		clear_CCIF(TIM4,2);								  			// clear capture/compare interrupt flag 
	}
}

void setup(){

	RCC_PLL_init(); 
	SysTick_init();
	UART2_init();
  
// PWM configuration ---------------------------------------------------------------------	
	PWM_init(TRIG);							  	// PA_6: Ultrasonic trig pulse
	PWM_period_us(TRIG, 50000);     // PWM of 50ms period. Use period_us()
	PWM_pulsewidth_us(TRIG, 10);    // PWM pulse width of 10us
	
// Input Capture configuration -----------------------------------------------------------------------	
	ICAP_init(ECHO);    							// PB_6 as input caputre
 	ICAP_counter_us(ECHO, 10);   			// ICAP counter step time as 10us
	ICAP_setup(ECHO, IC_1, IC_RISE);  // TIM4_CH1 as IC1 , rising edge detect
	ICAP_setup(ECHO, IC_2, IC_FALL);  // TIM4_CH2 as IC2 , falling edge detect
}
```

- setup
  - Timer and sensor settings
  - pwm settings (TRIG)
  - Input capture setting (ECHO)
- while
  - distance output
- Time interrupt
  - Overflow measurement
  - time capture (Rising edge)
  - time capture (Falling edge)
  - time inteval (msec)

### Results

1) results 

| a) 10mm                                                      | b) 50mm                                                      | c) 100mm                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20231107112822343](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231107112822343.png) | ![image-20231107112700527](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231107112700527.png) | ![image-20231107112443841](C:\Users\ksw86\AppData\Roaming\Typora\typora-user-images\image-20231107112443841.png) |

 Distances were measured in a total of three cases. At this time, the sensor did not measure the distance properly at 10mm, and measured the distance properly at 50mm and 100mm. When experimentally determining the measurable distance of the sensor, it was found that approximately 3cm was the minimum measurable distance.

2) demo vedio: [EC_LAB: Input Capture - Ultrasonic_김선우 ](https://www.youtube.com/watch?v=50CqHt1I-Y8)

## Reference

Gitbook: [LAB: Input Capture - Ultrasonic - EC (gitbook.io)](https://ykkim.gitbook.io/ec/ec-course/lab/lab-input-capture-ultrasonic)



## Troubleshooting







